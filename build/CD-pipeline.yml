
- stage: 'CD_DEV'
  displayName: 'Deploy the application to the TEST environment '
  variables:
  - name: 'resourcegroupname'
    value: 'ms-csu-nl-jvw-javademoapp-test'
  - name: 'armtemplatefile'
    value: 'application-resources.json'
  - name: 'armtemplateparams'
    value: 'parameters.test.json'
  jobs:
  - job:
    displayName: 'Downloading artifacts'
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        artifactName: 'drop'
        downloadType: 'single'
        downloadPath: '$(System.ArtifactsDirectory)'

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: 'Deploy Azure Resources'
      enabled: true
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '$(serviceconnection)'
        subscriptionId: '$(subscriptionid)'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(resourcegroupname)'
        location: 'westeurope'
        templateLocation: 'Linked artifact'
        csmFile: '$(System.ArtifactsDirectory)/drop/infra/$(armtemplatefile)'
        csmParametersFile: '$(System.ArtifactsDirectory)/drop/infra/$(armtemplateparams)'
        deploymentMode: 'Incremental'
        deploymentOutputs: 'resource_outputs'

    - task: PowerShell@2
      displayName: 'Make ARM output variables available for subsequent steps as $(arm_<whatever>)'
      enabled: true
      inputs:
        targetType: 'inline'
        script: |
          $outputs = ConvertFrom-Json '$(resource_outputs)'
            foreach ($output in $outputs.PSObject.Properties) {
              Write-Host "##vso[task.setvariable variable=arm_$($output.Name)]$($output.Value.value)"
            }

    - task: AzureAppServiceSettings@1
      displayName: 'Update WebApp settings with AppInsights instrumentation key'
      enabled: true
      inputs:
        azureSubscription: '$(serviceconnection)'
        appName: '$(arm_webappname)'
        resourceGroupName: '$(resourcegroupname)'
        appSettings: |
          [
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "$(arm_appinsightskey)"
            },
            {
              "name": "JAVA_OPTS",
              "value": "-Dspring.profiles.active=azuretest -javaagent:/home/site/wwwroot/applicationinsights-agent-2.5.1.jar"
            },
            {
              "name": "KEYVAULTURL",
              "value": "$(arm_keyvaulturl)"
            }
          ]

    - task: ArchiveFiles@2
      displayName: 'Zip up application + agent JAR'
      inputs:
        rootFolderOrFile: '$(System.ArtifactsDirectory)/drop/app'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/app_package.zip'
        replaceExistingArchive: true

    - task: AzureRmWebAppDeployment@4
      displayName: 'Deploy application package to WebApp'
      inputs:
        ConnectionType: 'AzureRM'
        azureSubscription: 'Microsoft Azure Internal Consumption(5fcb0d36-846f-4721-86e9-47f6c43494fd)'
        appType: 'webAppLinux'
        WebAppName: 'demo-test-api-we'
        packageForLinux: '$(Build.ArtifactStagingDirectory)/app_package.zip'
        RuntimeStack: 'JAVA|8-jre8'